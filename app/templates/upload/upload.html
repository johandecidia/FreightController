{% extends "base/base.html" %}
{% load static %}

    {% block content %}
        <div class="w-full max-w-lg p-8 bg-white rounded-2xl shadow">
            <h1 class="text-2xl font-bold mb-4 text-center">Upload a File</h1>

            <div id="dropzone"
                 class="border-4 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer bg-gray-50 hover:bg-gray-100"
                 hx-post="."
                 hx-target="#upload-result"
                 hx-encoding="multipart/form-data">

                <input type="file" name="file" id="fileInput" class="hidden">
                <p class="text-gray-600">Drag and drop a file here or <span class="text-blue-500 underline">click to browse</span></p>
            </div>

            <div id="upload-result" class="mt-6 text-center text-sm text-gray-700"></div>
        </div>

        <script>
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');

            dropzone.addEventListener('click', () => fileInput.click());
            dropzone.addEventListener('dragover', e => {
                e.preventDefault();
                dropzone.classList.add('bg-blue-50');
            });
            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('bg-blue-50');
            });
            dropzone.addEventListener('drop', e => {
                e.preventDefault();
                dropzone.classList.remove('bg-blue-50');
                const file = e.dataTransfer.files[0];
                uploadFile(file);
            });
            fileInput.addEventListener('change', e => {
                uploadFile(e.target.files[0]);
            });
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function uploadFile(file) {
                const formData = new FormData();
                formData.append('file', file);

                fetch('.', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                })
                .then(r => r.json())
                .then(data => {
                    document.getElementById('upload-result').innerHTML =
                        data.error ? `<p class='text-red-500'>${data.error}</p>`
                                   : `<p class='text-green-600'>âœ… ${data.file_name} uploaded (${data.file_type})</p>`;
                });
            }
        </script>

    {% endblock %}

